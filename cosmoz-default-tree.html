<link rel="import" href="cosmoz-tree.html">

<!--
Navigator through object with treelike datastructure and default settings.

@demo demo/index.html
-->

<script>
	'use strict';

	Polymer({ is: 'cosmoz-default-tree' });

	window.Cosmoz = window.Cosmoz || {};

	function _objectValues(obj) {
		return Object.keys(obj).map(function (key) {
			return obj[key];
		});
	}

	/**
	 * Cosmoz.DefaultTree
	 *
	 * @constructor
	 */
	Cosmoz.DefaultTree = function (treeData) {
		Cosmoz.Tree.apply(this, arguments);
		this._treeData = treeData;
		this._roots = _objectValues(treeData);
	};

	Cosmoz.DefaultTree.prototype = Object.create(Cosmoz.Tree.prototype);

	/**
	 * Returns an Array with all found Nodes.
	 * Returns an Object with the first found Node.
	 */
	Cosmoz.DefaultTree.prototype.getNodeByProperty = function (propertyName, propertyValue, exact, all, nodeList) {
		if (propertyName === undefined || propertyValue === undefined) {
			return;
		}

		// Defaults
		exact = exact !== undefined ? exact : true;
		all = all !== undefined ? all : false;

		if (propertyName === 'pathLocator') {
			return this.getNodeByPathLocator(propertyValue);
		}

		return this._searchNodeList(propertyName, propertyValue, exact, all, nodeList);
	};

	/**
	 * Returns the path String of the found Node(s).
	 */
	Cosmoz.DefaultTree.prototype.getPathByProperty = function (propertyName, propertyValue, exact, all, nodeList) {
		var node = this.getNodeByProperty(propertyName, propertyValue, exact, all, nodeList);
		if (!node) {
			return;
		}
		return this.getPath(node.path, propertyName);
	},

	/**
	 * Loops over a node list (or roots if not defined) and returns the concatenated results of search().
	 */
	Cosmoz.DefaultTree.prototype._searchNodeList = function (propertyName, propertyValue, exact, all, nodeList) {
		var results = [];

		// Defaults
		exact = exact !== undefined ? exact : true;
		all = all !== undefined ? all : false;
		nodeList = nodeList ? nodeList : this._roots;

		nodeList.forEach(function (node) {
			results = results.concat(this.search(node, propertyName, propertyValue, exact, all));
		}, this);
			
		return results;
	};

	/**
	 * Returns the Node of a given pathLocator.
	 */
	Cosmoz.DefaultTree.prototype.getNodeByPathLocator = function (pathLocator) {
		if (!pathLocator) {
			return this._treeData;
		}
		var	nodesOnPath = this.getNodesOnPath(pathLocator, this._treeData);
		return nodesOnPath[nodesOnPath.length - 1];
	};

	/**
	 * Returns an Array of nodes on a given path.
	 * If pathLocator is empty or not defined, the Root objects get returned.
	 */
	Cosmoz.DefaultTree.prototype.getNodesOnPath = function (pathLocator, nodes, separatorSign) {
		if (!pathLocator) {
			return this._roots
		};

		// Defaults
		separatorSign = separatorSign ? separatorSign : '.'

		var path = pathLocator.split(separatorSign),
			pathSegment = nodes ? nodes : this._treeData;
		
		return path.map(function (nodeKey) {
			var node = pathSegment[nodeKey],
				children = this.getChildren(node);
			node['key'] = nodeKey;
			if (node && children !== undefined && Object.keys(children).length > 0) {
				pathSegment = children;
			}
			return node;
		}, this);
	},

	/**
	 * Returns a String (separated node comparison properties) representing the path.
	 */
	Cosmoz.DefaultTree.prototype.getPath = function (pathLocator, comparisonProperty, pathSeparator) {
		var nodesOnPath = this.getNodesOnPath(pathLocator, this._treeData),
			path;
		
		// Defaults
		pathSeparator = pathSeparator ? pathSeparator : '/';

		return nodesOnPath.map(function (node) {
			return node[comparisonProperty];
		}).join(pathSeparator);
	};

	/**
	 * Returns an Object or an Array representing the children of a node.
	 */
	Cosmoz.DefaultTree.prototype.getChildren = function (node, asList) {
		if (!node) {
			return;
		}
		return asList ? _objectValues(node.children) : node.children;
	};

	/**
	 * Returns the property of a Node based on a given property name.
	 */
	Cosmoz.DefaultTree.prototype.getProperty = function (node, propertyName) {
		if (!node || !propertyName) {
			return;
		}
		return node[propertyName];
	};

</script>