<script>
	'use strict';

	if (typeof Cosmoz === 'undefined') {
		var Cosmoz = {};
	}

	/**
	 *
	 * @constructor
	 */
	Cosmoz.Tree = function (node) {
		this._node = node;
		this._flattenedTree = this._flattenTree(node);
		this._pathLocatorSeparator = '.';
	};

	Cosmoz.Tree.prototype = {

		constructor: Cosmoz.Tree,

		findNodeById: function (id) {
			return this._flattenedTree[id];
		},

		findNodeByPathLocator: function (pathLocator) {
			if (!pathLocator) {
				return;
			}
			return pathLocator
				.split(this._pathLocatorSeparator)
				.reduce(function (node, part) {
					if (node.children) {
						node = node.children;
					}
					if (node[part]) {
						node = node[part];
					}
					return node;
				}, this._node);
		},

		getPath: function (keyId) {
			if (this.isGuid(keyId)) {
				return this.getPathByNodeId(keyId);
			}
			return this.getPathByLocator(keyId);
		},

		getPathByNode: function (node) {
			if (!node || !node.pathLocator) {
				return;
			}
			var currentNode = this._node;
			return node.pathLocator
				.split(this._pathLocatorSeparator)
				.map(function (part) {
					var ret = currentNode;
					if (currentNode.children && currentNode.children[part]) {
						currentNode = currentNode.children[part];
					}
					if (currentNode[part]) {
						currentNode = currentNode[part];
					}
					if (ret === currentNode) {
						return;
					}
					return currentNode;
				})
				.filter(function (part) {
					return part !== undefined;
				});
		},

		getPathByNodeId: function (nodeId) {
			var node = this.findNodeById(nodeId);
			return this.getPathByNode(node);
		},

		getPathByLocator: function (locator) {
			var node = this.findNodeByPathLocator(locator);
			return this.getPathByNode(node);
		},

		getPathString: function (path, separator) {
			if (!path || !Array.isArray(path) || !path.length < 1) {
				return;
			}
			return path.map(function (part) {
				return part.name;
			}).join(separator);
		},

		isGuid: function (input) {  // FIXME: GUID Check
			return input && input.length === 36;
		},

		/**
		 * Utility function to flatten the tree to ease node lookup.
		 */
		_flattenTree: function (tree, flattened) {
			if (!flattened) {
				flattened = {};
			}

			if (tree === undefined) {
				return flattened;
			}

			Object.keys(tree).forEach(function (key) {
				var node = tree[key];
				flattened[node.id] = node;

				if (node.children && Object.keys(node.children).length > 0) {
					this._flattenTree(node.children, flattened);
				}

			}, this);

			return flattened;
		},
	};
</script>